# weather-service

### Introduction

This is a simple weather service that requests weather data given a city name.

### For Building the app is needed:

-   Java 11
-   Maven 3.x

### For Building the app is needed:

- Configure DB
- Configure Api Key for getting the weather data.
  The api key can be obtained by opening an account on http://api.openweathermap.org
  Property: 
  weather.api.appId

### Database Scripts

-   Liquibase is used to maintain and versioning the database changes

### Options to run the app

-   1.  Run the app by using H2 database
        application-dev.yml
-   2.  Run the app by using Postgres database that runs in the localhost
        application.yml
-   3.  Run the app in a docker container and connecting to Postgres database that runs in a docker container
        application-prod.yml

### Run the app connecting to H2 database

-    1.  Run H2 database for development purposes.
        
        In pom file replace FULL_PATH for the absolute path to the application
        Run the liquidbase for creating the database and tables:

        mvn liquibase:update
        
-    2.  Run the app with the dev profile

        In application-dev.yml file replace FULL_PATH for the absolute path to the application
    
-    3.  Build the app

        mvn clean install
    
-    4.  Run the app:

        java -Dspring.profiles.active=dev -jar target/simple-app-weather-0.0.1-SNAPSHOT.jar


### Run the app connecting to Postgres database

-   1.  Run the Postgres database and make it accessible through localhost
        We might run Postgres in a docker container. 
        Refers to Docker Container: Postgres
        
-   2.  Runt the app:

        mvn clean install
        mvn spring-boot:run


### Run the app in a docker container that connects to a Postgres database that runs in a docker container


### Docker Containers

-   It works with 2 docker images, one for postgres, and the second one for the application

-   Steps to run both docker containers

-   1.  Create a docker network. It allows the communication from the app container to the DB container
        docker network create weather_network

### Docker Container: Postgres

-   1.  Pull the postgres image
        docker pull postgres
-   2.  Run the Postgres Container with the name: weather-postgres
        
        Only the first time:
        
        docker run -d \
        --network weather_network \
        --name weather-postgres \
        -e POSTGRES_PASSWORD=mysecretpassword \
        -e PGDATA=/var/lib/postgresql/data/pgdata \
        -v /Users/my-user/dockerdata/postgres:/var/lib/postgresql/data \
        -p 5432:5432 \
        postgres
        
        After the first time:

        docker start -a weather-postgres
        
        Note: user and password:
        -   user: postgres
        -   password: mysecretpassword

-   3.  Create the database: weather-db
        docker exec -it weather-postgres createdb -U postgres weather-db
-   4.  Create table by connecting by a terminal.
        The table should be created by using liquidbase.
        In this step we are going to connect by a terminal to create the table.
        Connects to the database:
        
        docker exec -it weather-postgres psql -U postgres
    
        Commands:
        
        List all databases:
        \list
        
        Connect to the weather database:
        \connect weather-db
        
        Lists all tables in the database:
        \d
        
        Create the weather table:
        CREATE TABLE weather ( id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, city VARCHAR(255) NOT NULL, country VARCHAR(255) NOT NULL, temperature NUMERIC(5, 2) );
        
        Select the last 10 records:
        SELECT * FROM weather ORDER BY id DESC LIMIT 10;
        
        Quit the terminal
        \q
        
### Docker Container: Application

-   1.  Creates the docker image of the application

        mvn clean install
        mvn clean install -Pdocker

-   2.  Run the application container:
        
        First time:
        docker run --network weather_network --name weather-service -p 8082:8080 simple-app-weather
        
        After first time:
        docker start -a weather-service
        
        The app runs with the prod profile. It uses the application-prod.yml file.
        The server-ip of the database contains the name of the docker container of postgres which is weather-postgres
        
### Docker Compose

With a single file docker-compose.yml configuration we manage 2 docker containers.
Configure the absolute path to store the postgres data files, changed as needed:
/Users/my-user/dockerdata/postgres

-   1.  Run the app:
        docker-compose up


### Test the Application

http://localhost:8082/weather?city=London
        
        
### For Accessing the API Documentation:

#### JSON format:

-   http://localhost:8080/api-docs

#### HTML format:

-   http://localhost:8080/api-ui.html

#### Sample Request For Testing and Getting the Weather Data:

-   http://localhost:8080/weather?city=Bogota
